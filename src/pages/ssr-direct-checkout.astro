---
// Page checkout direct SSR - Version simplifi√©e
import GAConsentMode from '../components/GAConsentMode.astro';
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Syst√®me Souhaits R√©alis√©s - Checkout</title>
  <meta name="description" content="Acc√®de au Syst√®me Souhaits R√©alis√©s - La m√©thode compl√®te pour manifester tes d√©sirs.">
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  
  <!-- GA4 Consent Mode v2 -->
  <GAConsentMode />
  
  <!-- Import de la police Bebas Neue -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  
  <!-- Spiffy Script - DOIT √™tre dans le head -->
  <script>
    "use strict";!function(i,t){var f=t.spiffy=t.spiffy||[];if(!f.init){
    if(f.invoked)return void(t.console&&console.error&&console.warn("Spiffy Elements included twice."));
    f.invoked=!0,f.methods=["identify","config","debug","off","on"],f.factory=function(i){
    return function(){var t=Array.prototype.slice.call(arguments);return t.unshift(i),f.push(t),f}},
    f.methods.forEach(function(i){spiffy[i]=f.factory(i)}),f.load=function(t,f){if(!spiffy.ACCOUNT){
    spiffy.ACCOUNT=t,spiffy.DOMAIN=f;var e=i.createElement("script");e.type="text/javascript",
    e.async=!1,e.crossorigin="anonymous",e.src="https://js.static.spiffy.co/spiffy.js?a="+t;
    var n=i.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)}}}}(document,window),
    spiffy.SNIPPET_VERSION="1.1.0";
    spiffy.config({ hideSidebar: false });
    spiffy.load("sonnycourt");
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .checkout-page {
      min-height: 100vh;
      padding: 40px 20px;
      background: linear-gradient(180deg, #0a0a0a 0%, #1a0f2e 100%);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* Headline */
    .headline {
      text-align: center;
      margin-bottom: 20px;
      animation: fadeInDown 1s ease-out;
    }

    .headline h1 {
      font-family: 'Bebas Neue', cursive;
      font-size: clamp(3rem, 6vw, 5rem);
      font-weight: 400;
      letter-spacing: 0.03em;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      line-height: 1.1;
    }

    /* Subheadline */
    .subheadline {
      text-align: center;
      font-size: clamp(16px, 2.5vw, 22px);
      color: #ffffff;
      margin-bottom: 40px;
      animation: fadeInUp 1s ease-out 0.2s both;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    /* Scarcity Urgency Section */
    .scarcity-urgency {
      background: linear-gradient(135deg, rgba(20, 20, 22, 0.98) 0%, rgba(30, 20, 45, 0.95) 100%);
      border-radius: 20px;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto 60px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(102, 126, 234, 0.2);
      animation: fadeInUp 1s ease-out 0.4s both;
    }

    .discount-badge {
      display: inline-block;
      background: #ef4444;
      color: white;
      padding: 10px 25px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .countdown-title {
      color: #ffffff;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 15px;
      line-height: 1.2;
    }

    .countdown-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.2rem;
      margin-bottom: 25px;
    }

    .countdown-section {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .time-block {
      text-align: center;
      background: rgba(106, 90, 205, 0.1);
      border-radius: 15px;
      padding: 20px 15px;
      min-width: 90px;
      flex: 1;
      max-width: 120px;
    }

    .time-value {
      background: rgba(106, 90, 205, 0.2);
      border: 2px solid #6A5ACD;
      border-radius: 12px;
      padding: 15px 10px;
      font-size: 2.2rem;
      font-weight: 700;
      color: #ffffff;
      display: block;
      font-variant-numeric: tabular-nums;
      margin-bottom: 8px;
    }

    .time-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .time-separator {
      color: #6A5ACD;
      font-size: 2rem;
      font-weight: 700;
      align-self: center;
      margin: 0 5px;
    }

    .scarcity-section {
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .scarcity-text {
      color: #ffffff;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0;
    }

    #places {
      color: #ef4444;
      font-weight: 700;
      font-size: 1.4rem;
      animation: scarcityPulse 3s infinite;
    }

    .scarcity-text.sold-out {
      text-decoration: line-through;
      text-decoration-thickness: 2px;
      opacity: 0.6;
      color: rgba(255, 255, 255, 0.6);
    }

    .exceptional-offer {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 25px;
      border-radius: 30px;
      display: inline-block;
      margin-top: 0;
      font-weight: 700;
      font-size: 1.05rem;
      animation: pulse 1.5s infinite;
    }

    .exceptional-places {
      color: #fbbf24;
      font-weight: 800;
      font-size: 1.5rem;
    }

    /* Checkout Section */
    .checkout-section {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .spiffy-embed-wrapper {
      width: 100%;
    }

    .spiffy-checkout__container {
      min-height: 600px;
      width: 100%;
    }

    /* Animations */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
    }

    @keyframes scarcityPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes urgentPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.05); }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .checkout-page {
        padding: 20px 15px;
      }

      .scarcity-urgency {
        padding: 30px 20px;
      }

      .countdown-section {
        gap: 10px;
        flex-wrap: wrap;
      }

      .time-block {
        min-width: 70px;
        padding: 15px 10px;
        flex: 1 1 calc(50% - 10px);
        max-width: none;
      }

      .time-value {
        font-size: 1.8rem;
        padding: 12px 8px;
      }

      .time-label {
        font-size: 0.7rem;
      }

      .time-separator {
        font-size: 1.5rem;
        margin: 0 3px;
      }

      .countdown-title {
        font-size: 2rem;
      }

      .countdown-subtitle {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="checkout-page">
    <div class="container">
      <!-- Headline -->
      <div class="headline">
        <h1>La pi√®ce manquante pour manifester absolument<br>tout ce que tu veux facilement<span class="dots">...</span></h1>
      </div>
      
      <!-- Subheadline -->
      <div class="subheadline">
        Et le syst√®me qui reprogramme d√©finitivement ton subconscient<br>
        (inspir√© par les enseignements de Neville Goddard)
      </div>

      <!-- Scarcity Urgency -->
      <div class="scarcity-urgency" id="scarcityUrgency">
        <div class="discount-badge">-50% OFFRE LANCEMENT</div>
        <h2 class="countdown-title">Syst√®me Souhaits R√©alis√©s</h2>
        <p class="countdown-subtitle">L'offre se termine dans :</p>
        
        <div class="countdown-section">
          <div class="time-block">
            <span class="time-value" id="days">00</span>
            <span class="time-label">Jours</span>
          </div>
          <span class="time-separator">:</span>
          <div class="time-block">
            <span class="time-value" id="hours">00</span>
            <span class="time-label">Heures</span>
          </div>
          <span class="time-separator">:</span>
          <div class="time-block">
            <span class="time-value" id="minutes">00</span>
            <span class="time-label">Minutes</span>
          </div>
          <span class="time-separator">:</span>
          <div class="time-block">
            <span class="time-value" id="seconds">00</span>
            <span class="time-label">Secondes</span>
          </div>
        </div>
        
        <div class="scarcity-section">
          <p class="scarcity-text" id="scarcityText">
            <span class="places-count" id="places">80</span> places disponibles sur 300
          </p>
          <div class="exceptional-offer" id="exceptionalOffer" style="display: none;"></div>
        </div>
      </div>

      <!-- Checkout Embed -->
      <div class="checkout-section" id="checkoutSection">
        <div class="spiffy-embed-wrapper">
          <div class="spiffy-checkout__container" data-url="https://sonnycourt.spiffy.co/checkout/souhaits-realises"></div>
        </div>
        <!-- Message pour localhost (HTTPS requis) -->
        <div class="local-warning" id="localWarning" style="display: none;">
          <p style="text-align: center; color: #ffa500; padding: 20px; background: rgba(255, 165, 0, 0.1); border-radius: 10px; border: 1px solid rgba(255, 165, 0, 0.3);">
            ‚ö†Ô∏è L'embed Spiffy n√©cessite HTTPS et ne s'affichera pas en localhost.<br>
            Il fonctionnera correctement en production (domaine avec SSL).
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Token Verification & Scarcity Logic
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token') || '';
      const previewParam = urlParams.get('preview');
      
      // V√©rifier le mode preview
      let isPreview = false;
      let previewDay = 0;
      
      if (previewParam !== null) {
        const dayNumber = parseInt(previewParam, 10);
        if (!isNaN(dayNumber) && dayNumber >= 0 && dayNumber <= 17) {
          isPreview = true;
          previewDay = dayNumber;
          const hoursLabel = dayNumber * 24;
          console.log(`üîç Mode PREVIEW activ√© - Jour ${dayNumber} (${hoursLabel}h apr√®s inscription)`);
          showPreviewBanner(dayNumber);
          const previewData = calculatePreviewData(dayNumber);
          displayData(previewData);
          return;
        }
      }

      // Mode normal : v√©rification du token requise
      if (!token) {
        const storedToken = localStorage.getItem('ssr_token');
        if (storedToken) {
          window.location.href = `/ssr-direct-checkout?token=${storedToken}`;
          return;
        }
        window.location.href = '/ssr-inscription';
        return;
      }

      // Stocker le token
      localStorage.setItem('ssr_token', token);

      // V√©rifier le token et r√©cup√©rer les donn√©es
      async function checkTokenAndLoadData() {
        try {
          const response = await fetch(`/.netlify/functions/check-ssr-access?token=${encodeURIComponent(token || '')}`);
          
          // V√©rifier que la r√©ponse est valide
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const text = await response.text();
          if (!text) {
            throw new Error('R√©ponse vide du serveur');
          }
          
          const data = JSON.parse(text);

          if (!data.valid) {
            if (data.isExpired) {
              hideCheckout();
            } else {
              alert('Lien invalide. Veuillez utiliser le lien que vous avez re√ßu par email.');
              window.location.href = '/ssr-inscription';
            }
            return;
          }

          displayData(data);

          // Synchroniser toutes les minutes
          setInterval(async () => {
            try {
              const syncResponse = await fetch(`/.netlify/functions/check-ssr-access?token=${encodeURIComponent(token || '')}`);
              const syncData = await syncResponse.json();
              if (syncData.valid) {
                displayData(syncData);
                if (syncData.isExpired) {
                  hideCheckout();
                }
              }
            } catch (error) {
              console.error('Erreur de synchronisation:', error);
            }
          }, 60000);

        } catch (error) {
          console.error('Erreur lors de la v√©rification:', error);
          displayData({ places: 80, timeRemaining: 16 * 24 * 60 * 60, phase: 1, isReopened: false });
        }
      }

      // Afficher le bandeau preview
      function showPreviewBanner(dayNumber) {
        const banner = document.createElement('div');
        banner.id = 'previewBanner';
        const hoursLabel = dayNumber * 24;
        const timeLabel = dayNumber === 0 ? 'Inscription' : `${hoursLabel}h`;
        banner.innerHTML = `üîç PREVIEW J${dayNumber} (${timeLabel}) - Mode d√©monstration`;
        banner.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: linear-gradient(90deg, #ff6b00, #ff9500);
          color: white;
          text-align: center;
          padding: 10px 20px;
          font-weight: bold;
          font-size: 14px;
          z-index: 99999;
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        `;
        document.body.prepend(banner);
        // Ajouter du padding au body pour compenser le bandeau
        document.body.style.paddingTop = '40px';
      }

      function calculatePreviewData(dayNumber) {
        const PHASE1_PALIERS = [
          { heure: 0, places: 80 }, { heure: 4, places: 72 }, { heure: 8, places: 65 },
          { heure: 14, places: 56 }, { heure: 20, places: 47 }, { heure: 28, places: 39 },
          { heure: 36, places: 33 }, { heure: 44, places: 27 }, { heure: 56, places: 23 },
          { heure: 66, places: 20 }, { heure: 82, places: 17 }, { heure: 94, places: 15 },
          { heure: 106, places: 14 }, { heure: 118, places: 12 }, { heure: 128, places: 11 },
          { heure: 136, places: 9 }, { heure: 143, places: 8 }, { heure: 154, places: 6 },
          { heure: 162, places: 5 }, { heure: 174, places: 3 }, { heure: 182, places: 2 },
          { heure: 188, places: 0 }
        ];
        const PHASE2_PALIERS = [
          { heure: 0, places: 200 }, { heure: 6, places: 176 }, { heure: 12, places: 150 },
          { heure: 20, places: 124 }, { heure: 32, places: 104 }, { heure: 42, places: 88 },
          { heure: 58, places: 74 }, { heure: 70, places: 62 }, { heure: 84, places: 52 },
          { heure: 95, places: 44 }, { heure: 108, places: 36 }, { heure: 119, places: 30 },
          // 72h‚Üí48h: 30‚Üí9
          { heure: 124, places: 27 }, { heure: 128, places: 24 }, { heure: 132, places: 21 },
          { heure: 136, places: 18 }, { heure: 140, places: 15 }, { heure: 144, places: 12 },
          { heure: 148, places: 9 },
          // 48h‚Üí24h: 9‚Üí5
          { heure: 154, places: 8 }, { heure: 160, places: 7 }, { heure: 166, places: 6 },
          { heure: 172, places: 5 },
          // 24h‚Üí0h: 5‚Üí0
          { heure: 181, places: 4 }, { heure: 190, places: 3 }, { heure: 199, places: 2 },
          { heure: 208, places: 1 }, { heure: 216, places: 0 }
        ];
        const PHASE2_START_HOUR = 188;
        const TOTAL_COUNTDOWN_SECONDS = 16 * 24 * 60 * 60;

        // Pour preview=0, on est √† 0h (inscription)
        // Pour preview=X (X > 0), on est √† X * 24h
        const hoursElapsed = dayNumber * 24;
        let places = 0;
        let phase = 1;
        let isReopened = false;
        let isSoldOut = false;
        let isExpired = false;

        if (hoursElapsed < PHASE2_START_HOUR) {
          phase = 1;
          places = getPlacesFromPaliers(hoursElapsed, PHASE1_PALIERS);
          if (places === 0 && hoursElapsed < PHASE2_START_HOUR) {
            isSoldOut = true;
          }
        } else {
          phase = 2;
          isReopened = true;
          const phase2Hours = hoursElapsed - PHASE2_START_HOUR;
          places = getPlacesFromPaliers(phase2Hours, PHASE2_PALIERS);
          if (places === 0) {
            isExpired = true;
          }
        }

        const timeRemaining = Math.max(0, TOTAL_COUNTDOWN_SECONDS - (hoursElapsed * 3600));

        return {
          valid: true,
          phase: phase,
          places: places,
          timeRemaining: timeRemaining,
          isSoldOut: isSoldOut,
          isReopened: isReopened,
          isExpired: isExpired,
          isPreview: true
        };
      }

      function getPlacesFromPaliers(heuresEcoulees, paliers) {
        let places = paliers[0].places;
        for (const palier of paliers) {
          if (heuresEcoulees >= palier.heure) {
            places = palier.places;
          } else {
            break;
          }
        }
        return places;
      }

      function displayData(data) {
        // Mettre √† jour le countdown
        updateCountdown(data.timeRemaining);

        // Mettre √† jour les places
        updateScarcityDisplay(data);

        // Si expir√©, cacher le checkout
        if (data.isExpired) {
          hideCheckout();
        }
      }

      function updateCountdown(timeRemainingSeconds) {
        const days = Math.floor(timeRemainingSeconds / 86400);
        const hours = Math.floor((timeRemainingSeconds % 86400) / 3600);
        const minutes = Math.floor((timeRemainingSeconds % 3600) / 60);
        const seconds = timeRemainingSeconds % 60;

        const daysEl = document.getElementById('days');
        const hoursEl = document.getElementById('hours');
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');

        if (daysEl) daysEl.textContent = String(days).padStart(2, '0');
        if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
        if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
        if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');

        if (timeRemainingSeconds > 0) {
          setTimeout(() => {
            updateCountdown(Math.max(0, timeRemainingSeconds - 1));
          }, 1000);
        }
      }

      function updateScarcityDisplay(data) {
        const scarcityText = document.getElementById('scarcityText');
        const exceptionalOffer = document.getElementById('exceptionalOffer');

        if (!scarcityText) return;

        if (data.isExpired) {
          scarcityText.classList.add('sold-out');
          scarcityText.innerHTML = `L'offre est compl√®tement termin√©e`;
          if (exceptionalOffer) exceptionalOffer.style.display = 'none';
        } else if (data.isSoldOut && !data.isReopened) {
          scarcityText.classList.add('sold-out');
          scarcityText.innerHTML = `<span style="color: #ef4444;">RUPTURE DE STOCK</span> - Toutes les places sont parties !`;
        } else if (data.isReopened) {
          // Afficher "0 places disponibles sur 300" barr√© pour montrer la preuve de succ√®s
          scarcityText.classList.remove('sold-out');
          scarcityText.innerHTML = `<span style="text-decoration: line-through; opacity: 0.6;"><span class="places-count" id="places">0</span> places disponibles sur 300</span>`;
          if (exceptionalOffer) {
            exceptionalOffer.style.display = 'block';
            exceptionalOffer.innerHTML = `<span class="exceptional-places">${data.places}</span> places suppl√©mentaires restantes !`;
          }
        } else {
          scarcityText.classList.remove('sold-out');
          scarcityText.innerHTML = `<span class="places-count" id="places">${data.places}</span> places disponibles sur 300`;
          if (exceptionalOffer) exceptionalOffer.style.display = 'none';
        }
      }

      function hideCheckout() {
        const checkoutSection = document.getElementById('checkoutSection');
        if (checkoutSection) {
          checkoutSection.style.display = 'none';
        }
      }

      // D√©marrer la v√©rification
      checkTokenAndLoadData();

      // V√©rifier si on est en localhost
      const isLocalhost = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' ||
                         window.location.protocol === 'http:';
      
      if (isLocalhost) {
        // Afficher le message d'avertissement en local
        const localWarning = document.getElementById('localWarning');
        if (localWarning) {
          localWarning.style.display = 'block';
        }
        console.warn('‚ö†Ô∏è Mode localhost d√©tect√© - Spiffy n√©cessite HTTPS pour fonctionner');
      }
    });
  </script>
</body>
</html>
