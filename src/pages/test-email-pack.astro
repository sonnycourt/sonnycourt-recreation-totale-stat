---
import Layout from '../layouts/Layout.astro';
---

<Layout 
  title="Test Email Pack - Sonny Court" 
  description="Page de test pour l'endpoint generate-email-pack"
  showHeader={false}
  showFooter={false}
>
  <div style="min-height: 100vh; background: #f5f5f5; color: #333; padding: 40px 20px; font-family: system-ui, -apple-system, sans-serif;">
    <div style="max-width: 800px; margin: 0 auto;">
      <h1 style="font-size: 32px; margin-bottom: 30px; color: #f59e0b;">Test Email Pack Generator</h1>
      
      <form id="testForm" style="background: #ffffff; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <label for="email" style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
          Email :
        </label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          required
          placeholder="exemple@email.com"
          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; color: #333; font-size: 16px; margin-bottom: 20px; box-sizing: border-box;"
        />
        <div style="display: flex; gap: 12px;">
          <button 
            type="button"
            id="btnSonnet"
            style="flex: 1; background: #f59e0b; color: #fff; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;"
            onmouseover="this.style.opacity='0.9'"
            onmouseout="this.style.opacity='1'"
          >
            Générer avec Sonnet
          </button>
          <button 
            type="button"
            id="btnDeepSeek"
            style="flex: 1; background: #3b82f6; color: #fff; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;"
            onmouseover="this.style.opacity='0.9'"
            onmouseout="this.style.opacity='1'"
          >
            Générer avec DeepSeek
          </button>
        </div>
      </form>

      <div id="loading" style="display: none; text-align: center; padding: 20px; color: #f59e0b;">
        ⏳ Génération en cours...
      </div>

      <div id="error" style="display: none; background: #fee; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fcc;">
        <h3 style="color: #c00; margin-top: 0;">❌ Erreur</h3>
        <pre id="errorMessage" style="color: #c00; white-space: pre-wrap; margin: 0;"></pre>
      </div>

      <div id="result" style="display: none;">
        <h2 style="color: #f59e0b; margin-top: 0; margin-bottom: 20px;">✅ Aperçu de l'email</h2>
        
        <!-- Aperçu style email -->
        <div style="max-width: 600px; margin: 0 auto; padding: 40px; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-family: Arial, Helvetica, sans-serif; color: #333;">
          <h2 id="emailSubject" style="color: #333; font-size: 24px; margin-bottom: 20px; font-weight: 700;"></h2>
          <div id="emailBody" style="color: #333; font-size: 16px; line-height: 1.6;"></div>
        </div>

        <!-- Debug info -->
        <div style="margin-top: 30px; padding: 20px; background: #fff; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <h3 style="color: #f59e0b; margin-top: 0; font-size: 16px;">Debug Info</h3>
          <div style="margin-bottom: 15px;">
            <strong style="color: #333;">Modèle utilisé:</strong>
            <code id="modelDebug" style="color: #f59e0b; background: #f5f5f5; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-left: 10px; border: 1px solid #ddd;"></code>
          </div>
          <div style="margin-bottom: 15px;">
            <strong style="color: #333;">Token:</strong>
            <code id="tokenDebug" style="color: #f59e0b; background: #f5f5f5; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-left: 10px; border: 1px solid #ddd;"></code>
          </div>
          <div>
            <strong style="color: #333;">HTML Source:</strong>
            <pre id="htmlSource" style="color: #666; background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; margin-top: 10px; border: 1px solid #ddd;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('testForm');
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const errorMessage = document.getElementById('errorMessage');
  const result = document.getElementById('result');
  const emailSubject = document.getElementById('emailSubject');
  const emailBody = document.getElementById('emailBody');
  const tokenDebug = document.getElementById('tokenDebug');
  const htmlSource = document.getElementById('htmlSource');
  const modelDebug = document.getElementById('modelDebug');
  const btnSonnet = document.getElementById('btnSonnet');
  const btnDeepSeek = document.getElementById('btnDeepSeek');

  // Fonction pour générer l'email avec un modèle spécifique
  async function generateEmail(model) {
    // Masquer les résultats précédents
    error.style.display = 'none';
    result.style.display = 'none';
    loading.style.display = 'block';

    const email = document.getElementById('email').value;
    
    if (!email) {
      alert('Veuillez entrer un email');
      loading.style.display = 'none';
      return;
    }

    try {
      const response = await fetch('/api/generate-email-pack', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, model })
      });

      loading.style.display = 'none';

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        errorMessage.textContent = JSON.stringify(errorData, null, 2);
        error.style.display = 'block';
        return;
      }

      const data = await response.json();
      
      // Debug : vérifier le contenu reçu
      console.log('Réponse API:', data);
      
      // Vérifier si l'email a été SKIP
      if (data.skipped) {
        console.log('⚠️ Email SKIP - raison:', data.reason);
        
        // Masquer le résultat normal
        result.style.display = 'none';
        
        // Afficher le message SKIP
        error.innerHTML = `
          <div style="background: #fee2e2; border: 1px solid #ef4444; padding: 20px; border-radius: 8px; text-align: center;">
            <h3 style="color: #dc2626; margin-top: 0;">❌ Email non généré</h3>
            <p style="margin-bottom: 10px; color: #333;">Les réponses au quiz sont inexploitables (charabia ou pas sérieuses).</p>
            <p style="margin: 0; color: #333;">Aucun email ne sera envoyé à ce contact.</p>
          </div>
        `;
        error.style.display = 'block';
        return;
      }
      
      // Si pas de skip, afficher l'email normalement
      console.log('Subject reçu:', data.subject);
      console.log('Body reçu (type):', typeof data.body);
      console.log('Body reçu (contenu):', data.body);
      console.log('Token reçu:', data.token);
      
      // Afficher l'aperçu de l'email
      emailSubject.textContent = data.subject || 'Aucun sujet';
      
      // S'assurer que le HTML est injecté correctement
      if (data.body) {
        emailBody.innerHTML = data.body;
      } else {
        emailBody.innerHTML = '<p>Aucun contenu</p>';
      }
      
      // Afficher les infos de debug
      modelDebug.textContent = model === 'deepseek' ? 'DeepSeek' : 'Claude Sonnet';
      tokenDebug.textContent = data.token || 'N/A';
      htmlSource.textContent = data.body || '';
      
      result.style.display = 'block';

    } catch (err) {
      loading.style.display = 'none';
      errorMessage.textContent = `Erreur: ${err.message}`;
      error.style.display = 'block';
      console.error('Erreur:', err);
    }
  }

  // Écouter les clics sur les boutons
  btnSonnet.addEventListener('click', () => generateEmail('sonnet'));
  btnDeepSeek.addEventListener('click', () => generateEmail('deepseek'));

  // Empêcher la soumission du formulaire avec Enter
  form.addEventListener('submit', (e) => {
    e.preventDefault();
  });
</script>
