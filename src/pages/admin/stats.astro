---
// Dashboard de stats pour les pages /cc/ (newsletter)
---

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats Newsletter - Sonny Court</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="robots" content="noindex, nofollow" />
</head>
<body style="margin:0;padding:40px 20px;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;background:#0d0d12;color:#fff;min-height:100vh;">
    <div style="max-width:900px;margin:0 auto;">
        <div style="text-align:center;margin-bottom:40px;">
            <h1 style="font-size:2rem;font-weight:700;margin:0 0 8px 0;">üìä <span style="color:#a78bfa;">Stats Newsletter</span></h1>
            <p style="color:#6b7280;margin:0;font-size:0.95rem;">Tracking des clics Court-Circuit</p>
        </div>

        <div id="content">
            <div style="text-align:center;padding:60px;color:#6b7280;">
                <div style="width:32px;height:32px;border:3px solid #2d2d3a;border-top-color:#a78bfa;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
                <p>Chargement...</p>
            </div>
        </div>

        <div style="text-align:center;margin-top:24px;">
            <button onclick="loadStats()" style="display:inline-flex;align-items:center;gap:8px;background:#a78bfa;color:#0d0d12;border:none;padding:10px 20px;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;">
                ‚Üª Rafra√Æchir
            </button>
            <p id="lastUpdated" style="color:#6b7280;font-size:0.8rem;margin-top:8px;"></p>
        </div>
    </div>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <script is:inline>
        let statsData = null;
        let currentTimeframe = 'week';

        function getMiddleNumber(pagePath) {
            const match = pagePath.match(/\/cc\/\d(\d{3})\d\//);
            return match ? parseInt(match[1], 10) : 999;
        }

        function getChartData(daily, timeframe) {
            const today = new Date();
            let days;

            switch (timeframe) {
                case 'week': days = 7; break;
                case 'month': days = 30; break;
                case 'year': days = 90; break;
                case 'all': days = 365; break;
                default: days = 7;
            }

            const data = [];
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayData = daily[dateStr] || {};
                const total = Object.values(dayData).reduce((a, b) => a + b, 0);
                
                let label = '';
                if (timeframe === 'week') {
                    label = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                } else if (timeframe === 'month' && (i % 5 === 0 || i === 0)) {
                    label = date.getDate().toString();
                } else if ((timeframe === 'year' || timeframe === 'all') && date.getDate() === 1) {
                    label = date.toLocaleDateString('fr-FR', { month: 'short' });
                }
                
                data.push({ date: dateStr, value: total, label });
            }

            // For year/all, aggregate by week
            if (timeframe === 'year' || timeframe === 'all') {
                const aggregated = [];
                const chunkSize = 7;
                for (let i = 0; i < data.length; i += chunkSize) {
                    const chunk = data.slice(i, i + chunkSize);
                    const sum = chunk.reduce((a, b) => a + b.value, 0);
                    const lastItem = chunk[chunk.length - 1];
                    aggregated.push({
                        value: sum,
                        label: aggregated.length % 4 === 0 ? `S${aggregated.length + 1}` : ''
                    });
                }
                return aggregated.slice(-12);
            }

            return data;
        }

        function renderChart(daily, timeframe) {
            const data = getChartData(daily, timeframe);
            const total = data.reduce((a, b) => a + b.value, 0);
            const maxValue = Math.max(...data.map(d => d.value), 1);

            const tabStyle = (active) => `
                padding:8px 14px;
                border:none;
                background:${active ? '#a78bfa' : 'transparent'};
                color:${active ? '#fff' : '#6b7280'};
                font-size:0.8rem;
                font-weight:500;
                cursor:pointer;
                border-radius:6px;
            `;

            const bars = data.map(d => {
                const height = Math.max((d.value / maxValue) * 120, d.value > 0 ? 6 : 3);
                return `
                    <div style="flex:1;display:flex;flex-direction:column;align-items:center;min-width:20px;max-width:50px;">
                        <div style="font-size:0.7rem;font-weight:600;color:#a78bfa;height:18px;display:flex;align-items:flex-end;">${d.value > 0 ? d.value : ''}</div>
                        <div style="width:100%;max-width:30px;height:${height}px;background:linear-gradient(180deg,#a78bfa 0%,#7c3aed 100%);border-radius:3px 3px 0 0;margin-top:4px;"></div>
                        <div style="font-size:0.6rem;color:#6b7280;margin-top:6px;height:14px;">${d.label}</div>
                    </div>
                `;
            }).join('');

            const periodLabels = { 'week': '7 jours', 'month': '30 jours', 'year': '12 semaines', 'all': 'tout' };

            return `
                <div style="background:#16161d;border:1px solid #2d2d3a;border-radius:12px;padding:20px;margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
                        <div style="font-size:1rem;font-weight:600;">üìà √âvolution des clics</div>
                        <div style="display:flex;gap:4px;background:#0d0d12;padding:4px;border-radius:8px;">
                            <button onclick="changeTimeframe('week')" style="${tabStyle(timeframe === 'week')}">7j</button>
                            <button onclick="changeTimeframe('month')" style="${tabStyle(timeframe === 'month')}">30j</button>
                            <button onclick="changeTimeframe('year')" style="${tabStyle(timeframe === 'year')}">12s</button>
                            <button onclick="changeTimeframe('all')" style="${tabStyle(timeframe === 'all')}">Tout</button>
                        </div>
                    </div>
                    <div style="display:flex;align-items:flex-end;justify-content:space-between;height:160px;gap:4px;padding:0 4px;">
                        ${bars}
                    </div>
                    <div style="display:flex;justify-content:center;gap:40px;margin-top:20px;padding-top:16px;border-top:1px solid #2d2d3a;">
                        <div style="text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#a78bfa;">${total}</div>
                            <div style="font-size:0.75rem;color:#6b7280;">Total (${periodLabels[timeframe]})</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeTimeframe(tf) {
            currentTimeframe = tf;
            if (statsData) renderStats(statsData);
        }

        function renderStats(data) {
            statsData = data;
            const content = document.getElementById('content');
            const { summary, pages, daily } = data;

            let html = `
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px;">
                    <div style="background:#16161d;border:1px solid #2d2d3a;border-radius:12px;padding:20px;text-align:center;">
                        <div style="font-size:2.5rem;font-weight:700;color:#a78bfa;">${summary.totalVisits}</div>
                        <div style="color:#6b7280;font-size:0.85rem;margin-top:4px;">Visites totales</div>
                    </div>
                    <div style="background:#16161d;border:1px solid #2d2d3a;border-radius:12px;padding:20px;text-align:center;">
                        <div style="font-size:2.5rem;font-weight:700;color:#a78bfa;">${summary.totalPages}</div>
                        <div style="color:#6b7280;font-size:0.85rem;margin-top:4px;">Pages track√©es</div>
                    </div>
                </div>
            `;

            html += renderChart(daily, currentTimeframe);

            if (pages.length > 0) {
                html += `<h2 style="font-size:1rem;font-weight:600;margin-bottom:16px;">üìÑ D√©tail par page</h2>`;
                html += `<div style="background:#16161d;border:1px solid #2d2d3a;border-radius:12px;overflow:hidden;">`;
                html += `<div style="display:grid;grid-template-columns:2fr 1fr 1fr;padding:12px 16px;background:#1e1e28;font-weight:600;font-size:0.75rem;color:#6b7280;text-transform:uppercase;">
                    <div>Page</div><div>Visites</div><div>Derni√®re visite</div>
                </div>`;

                pages.sort((a, b) => getMiddleNumber(a.page) - getMiddleNumber(b.page));

                for (const page of pages) {
                    const middleNum = getMiddleNumber(page.page).toString().padStart(3, '0');
                    html += `
                        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;padding:14px 16px;border-top:1px solid #2d2d3a;align-items:center;">
                            <div><a href="${page.page}" target="_blank" style="color:#60a5fa;text-decoration:none;font-weight:500;">${page.page}</a><span style="color:#6b7280;font-size:0.8rem;margin-left:6px;">#${middleNum}</span></div>
                            <div style="font-weight:700;color:#a78bfa;font-size:1.1rem;">${page.total}</div>
                            <div style="color:#6b7280;font-size:0.85rem;">${page.lastVisit || '-'}</div>
                        </div>
                    `;
                }
                html += `</div>`;
            } else {
                html += `<div style="text-align:center;padding:40px;color:#6b7280;"><p>Aucune visite enregistr√©e.</p></div>`;
            }

            content.innerHTML = html;
            document.getElementById('lastUpdated').textContent = `Mis √† jour : ${new Date().toLocaleTimeString('fr-FR')}`;
        }

        async function loadStats() {
            const content = document.getElementById('content');
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                if (data.error) {
                    content.innerHTML = `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:20px;text-align:center;color:#ef4444;">‚ùå ${data.error}</div>`;
                    return;
                }
                renderStats(data);
            } catch (error) {
                content.innerHTML = `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:20px;text-align:center;color:#ef4444;">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        loadStats();
    </script>
</body>
</html>
