---
// Dashboard de stats pour les pages /cc/ (newsletter)
// Protégé par code d'accès
---

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats Newsletter - Sonny Court</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="robots" content="noindex, nofollow" />
</head>
<body style="margin:0;padding:40px 20px;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;background:#0a0a0f;color:#fff;min-height:100vh;">

    <!-- Login Screen -->
    <div id="loginScreen" style="max-width:400px;margin:100px auto;text-align:center;">
        <div style="background:#1C1C1E;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:40px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:20px;">
                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <h1 style="font-size:1.5rem;font-weight:700;margin:0 0 8px 0;color:#fff;">Accès restreint</h1>
            <p style="color:#6b7280;margin:0 0 24px 0;font-size:0.9rem;">Entrez le code d'accès pour voir les stats</p>
            <input 
                type="password" 
                id="accessCode" 
                placeholder="Code d'accès"
                style="width:100%;padding:14px 16px;border:1px solid rgba(255,255,255,0.1);border-radius:10px;background:#0a0a0f;color:#fff;font-size:1rem;text-align:center;letter-spacing:4px;outline:none;box-sizing:border-box;"
                onkeypress="if(event.key==='Enter')checkAccess()"
            />
            <button 
                onclick="checkAccess()" 
                style="width:100%;margin-top:16px;padding:14px;background:#007AFF;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;"
            >
                Accéder
            </button>
            <p id="loginError" style="color:#ef4444;margin-top:16px;font-size:0.85rem;display:none;">Code incorrect</p>
        </div>
    </div>

    <!-- Dashboard (hidden by default) -->
    <div id="dashboard" style="display:none;max-width:900px;margin:0 auto;">
        <div style="text-align:center;margin-bottom:40px;">
            <h1 style="font-size:2rem;font-weight:700;margin:0 0 8px 0;display:flex;align-items:center;justify-content:center;gap:10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/><path d="M19 16v6"/><path d="M16 19h6"/></svg>
                <span style="color:#007AFF;">Stats Newsletter</span>
            </h1>
            <p style="color:#6b7280;margin:0;font-size:0.95rem;">Tracking des clics Court-Circuit</p>
        </div>

        <div id="content">
            <div style="text-align:center;padding:60px;color:#6b7280;">
                <div style="width:32px;height:32px;border:3px solid #1c1c1e;border-top-color:#007AFF;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
                <p>Chargement...</p>
            </div>
        </div>

        <div style="text-align:center;margin-top:24px;">
            <button onclick="loadStats()" style="display:inline-flex;align-items:center;gap:8px;background:#007AFF;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;">
                ↻ Rafraîchir
            </button>
            <button onclick="logout()" style="display:inline-flex;align-items:center;gap:8px;background:transparent;color:#6b7280;border:1px solid rgba(255,255,255,0.1);padding:10px 20px;border-radius:8px;font-size:0.9rem;font-weight:500;cursor:pointer;margin-left:8px;">
                Déconnexion
            </button>
            <p id="lastUpdated" style="color:#6b7280;font-size:0.8rem;margin-top:8px;"></p>
        </div>
    </div>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        #accessCode:focus { border-color: #007AFF; }
    </style>

    <script is:inline>
        const ACCESS_CODE = '261500';
        let statsData = null;
        let currentTimeframe = 'week';

        // Check if already authenticated
        function init() {
            const stored = localStorage.getItem('stats_access');
            if (stored === ACCESS_CODE) {
                showDashboard();
            }
        }

        function checkAccess() {
            const input = document.getElementById('accessCode').value;
            const error = document.getElementById('loginError');
            
            if (input === ACCESS_CODE) {
                localStorage.setItem('stats_access', ACCESS_CODE);
                showDashboard();
            } else {
                error.style.display = 'block';
                document.getElementById('accessCode').value = '';
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadStats();
        }

        function logout() {
            localStorage.removeItem('stats_access');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('accessCode').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function getMiddleNumber(pagePath) {
            const match = pagePath.match(/\/cc\/\d(\d{3})\d\//);
            return match ? parseInt(match[1], 10) : 999;
        }

        function getChartData(daily, timeframe) {
            const today = new Date();
            let days;

            switch (timeframe) {
                case 'week': days = 7; break;
                case 'month': days = 30; break;
                case 'year': days = 90; break;
                case 'all': days = 365; break;
                default: days = 7;
            }

            const data = [];
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayData = daily[dateStr] || {};
                const total = Object.values(dayData).reduce((a, b) => a + b, 0);
                
                let label = '';
                if (timeframe === 'week') {
                    label = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                } else if (timeframe === 'month' && (i % 5 === 0 || i === 0)) {
                    label = date.getDate().toString();
                } else if ((timeframe === 'year' || timeframe === 'all') && date.getDate() === 1) {
                    label = date.toLocaleDateString('fr-FR', { month: 'short' });
                }
                
                data.push({ date: dateStr, value: total, label });
            }

            if (timeframe === 'year' || timeframe === 'all') {
                const aggregated = [];
                const chunkSize = 7;
                for (let i = 0; i < data.length; i += chunkSize) {
                    const chunk = data.slice(i, i + chunkSize);
                    const sum = chunk.reduce((a, b) => a + b.value, 0);
                    aggregated.push({
                        value: sum,
                        label: aggregated.length % 4 === 0 ? 'S' + (aggregated.length + 1) : ''
                    });
                }
                return aggregated.slice(-12);
            }

            return data;
        }

        function renderChart(daily, timeframe) {
            const data = getChartData(daily, timeframe);
            const total = data.reduce((a, b) => a + b.value, 0);
            const maxValue = Math.max(...data.map(d => d.value), 1);

            const tabStyle = (active) => `
                padding:8px 14px;
                border:none;
                background:${active ? '#007AFF' : 'transparent'};
                color:${active ? '#fff' : '#6b7280'};
                font-size:0.8rem;
                font-weight:500;
                cursor:pointer;
                border-radius:6px;
            `;

            const bars = data.map(d => {
                const height = Math.max((d.value / maxValue) * 120, d.value > 0 ? 6 : 3);
                return `
                    <div style="flex:1;display:flex;flex-direction:column;align-items:center;min-width:20px;max-width:50px;">
                        <div style="font-size:0.7rem;font-weight:600;color:#fff;height:18px;display:flex;align-items:flex-end;">${d.value > 0 ? d.value : ''}</div>
                        <div style="width:100%;max-width:30px;height:${height}px;background:linear-gradient(180deg,#007AFF 0%,#0051D5 100%);border-radius:3px 3px 0 0;margin-top:4px;"></div>
                        <div style="font-size:0.6rem;color:#6b7280;margin-top:6px;height:14px;">${d.label}</div>
                    </div>
                `;
            }).join('');

            const periodLabels = { 'week': '7 jours', 'month': '30 jours', 'year': '12 semaines', 'all': 'tout' };

            return `
                <div style="background:#1C1C1E;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
                        <div style="font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="M7 11.207a.5.5 0 0 1 .146-.353l2-2a.5.5 0 0 1 .708 0l3.292 3.292a.5.5 0 0 0 .708 0l4.292-4.292a.5.5 0 0 1 .854.353V16a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1z"/></svg> Évolution des clics</div>
                        <div style="display:flex;gap:4px;background:#0a0a0f;padding:4px;border-radius:8px;">
                            <button onclick="changeTimeframe('week')" style="${tabStyle(timeframe === 'week')}">7j</button>
                            <button onclick="changeTimeframe('month')" style="${tabStyle(timeframe === 'month')}">30j</button>
                            <button onclick="changeTimeframe('year')" style="${tabStyle(timeframe === 'year')}">12s</button>
                            <button onclick="changeTimeframe('all')" style="${tabStyle(timeframe === 'all')}">Tout</button>
                        </div>
                    </div>
                    <div style="display:flex;align-items:flex-end;justify-content:space-between;height:160px;gap:4px;padding:0 4px;">
                        ${bars}
                    </div>
                    <div style="display:flex;justify-content:center;gap:40px;margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.08);">
                        <div style="text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:#fff;">${total}</div>
                            <div style="font-size:0.75rem;color:#6b7280;">Total (${periodLabels[timeframe]})</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeTimeframe(tf) {
            currentTimeframe = tf;
            if (statsData) renderStats(statsData);
        }

        function renderStats(data) {
            statsData = data;
            const content = document.getElementById('content');
            const { summary, pages, daily } = data;

            let html = `
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px;">
                    <div style="background:#1C1C1E;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;text-align:center;">
                        <div style="font-size:2.5rem;font-weight:700;color:#fff;">${summary.totalVisits}</div>
                        <div style="color:#6b7280;font-size:0.85rem;margin-top:4px;">Visites totales</div>
                    </div>
                    <div style="background:#1C1C1E;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;text-align:center;">
                        <div style="font-size:2.5rem;font-weight:700;color:#fff;">${summary.totalPages}</div>
                        <div style="color:#6b7280;font-size:0.85rem;margin-top:4px;">Pages trackées</div>
                    </div>
                </div>
            `;

            html += renderChart(daily, currentTimeframe);

            if (pages.length > 0) {
                html += `<h2 style="font-size:1rem;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 5H3"/><path d="M16 12H3"/><path d="M11 19H3"/><path d="m15 18 2 2 4-4"/></svg> Détail par page</h2>`;
                html += `<div style="background:#1C1C1E;border:1px solid rgba(255,255,255,0.08);border-radius:12px;overflow:hidden;">`;
                html += `<div style="display:grid;grid-template-columns:2fr 1fr 1fr;padding:12px 16px;background:rgba(255,255,255,0.03);font-weight:600;font-size:0.75rem;color:#6b7280;text-transform:uppercase;">
                    <div>Page</div><div>Visites</div><div>Dernière visite</div>
                </div>`;

                pages.sort((a, b) => getMiddleNumber(a.page) - getMiddleNumber(b.page));

                for (const page of pages) {
                    const middleNum = getMiddleNumber(page.page).toString().padStart(3, '0');
                    html += `
                        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;padding:14px 16px;border-top:1px solid rgba(255,255,255,0.05);align-items:center;">
                            <div><a href="${page.page}" target="_blank" style="color:#64b5f6;text-decoration:none;font-weight:500;">${page.page}</a><span style="color:#6b7280;font-size:0.8rem;margin-left:6px;">#${middleNum}</span></div>
                            <div style="font-weight:700;color:#fff;font-size:1.1rem;">${page.total}</div>
                            <div style="color:#6b7280;font-size:0.85rem;">${page.lastVisit || '-'}</div>
                        </div>
                    `;
                }
                html += `</div>`;
            } else {
                html += `<div style="text-align:center;padding:40px;color:#6b7280;"><p>Aucune visite enregistrée.</p></div>`;
            }

            content.innerHTML = html;
            document.getElementById('lastUpdated').textContent = `Mis à jour : ${new Date().toLocaleTimeString('fr-FR')}`;
        }

        async function loadStats() {
            const content = document.getElementById('content');
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                if (data.error) {
                    content.innerHTML = `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:20px;text-align:center;color:#ef4444;">❌ ${data.error}</div>`;
                    return;
                }
                renderStats(data);
            } catch (error) {
                content.innerHTML = `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:20px;text-align:center;color:#ef4444;">❌ Erreur: ${error.message}</div>`;
            }
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
