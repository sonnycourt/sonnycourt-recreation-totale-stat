---
/**
 * Layout pour les pages Court-Circuit (/cc/)
 * Inclut automatiquement :
 * - Le layout principal (header, footer, GA4)
 * - Le tracking des visites (sans cookies)
 * - Les styles communs des pages /cc/
 * 
 * Usage:
 * ---
 * import CCLayout from '../../layouts/CCLayout.astro';
 * ---
 * <CCLayout title="Court-Circuit" image="/media/newsletter/court-circuit-X.webp">
 *   <!-- contenu sp√©cifique -->
 * </CCLayout>
 */

import Layout from './Layout.astro';

export interface Props {
  title?: string;
  description?: string;
  image: string; // Image du court-circuit du jour (obligatoire)
}

const { 
  title = "Court-Circuit - Sonny Court",
  description = "D√©couvre les formations de Sonny Court pour reprogrammer ton subconscient et transformer ta vie.",
  image
} = Astro.props;

// Extraire l'ID de la page depuis l'URL pour le lien de partage
const currentPath = Astro.url.pathname;
const pageId = currentPath.split('/').filter(Boolean).pop() || '';
const shareUrl = `https://sonnycourt.com/cc-share/${pageId}`;
---

<Layout title={title} description={description} noindex={true}>
  <div class="court-circuit-page">
    <!-- Image Section -->
    <section class="image-section">
      <div class="image-container">
        <img 
          src={image} 
          alt="Court-Circuit du jour" 
          class="main-image"
        />
      </div>
      
      <!-- Slot pour contenu apr√®s l'image (ex: titre personnalis√©) -->
      <slot name="after-image" />
      
      <!-- Bouton Partage -->
      <div class="share-button-container">
        <button class="share-btn-main" id="shareMainBtn" data-share-url={shareUrl}>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          <span>Partager √† un ami</span>
        </button>
        <span class="share-copied-toast" id="shareCopiedToast">Lien copi√© !</span>
      </div>
    </section>

    <!-- Formations Carousel Section -->
    <section class="formations-carousel-section">
      <h2 class="section-title">La suite de ton aventure üëá</h2>
      
      <div class="carousel-container">
        <button class="carousel-arrow prev" aria-label="Pr√©c√©dent">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div class="carousel-track-wrapper">
          <div class="carousel-track">
            <!-- Formation 1: Manifest -->
            <div class="formation-slide">
              <img 
                src="https://i1.wp.com/sonnycourt.com/wp-content/uploads/2025/07/Sonny-Court-Manifest-Formation.webp"
                alt="Formation MANIFEST"
                loading="lazy"
              />
              <div class="formation-info">
                <h3>MANIFEST</h3>
                <p>3 mois pour manifester la richesse, l'amour et la libert√©.</p>
                <a href="/inscription-manifest" class="formation-btn">Voir vid√©o gratuite</a>
              </div>
            </div>

            <!-- Formation 2: Syst√®me Souhaits R√©alis√©s -->
            <div class="formation-slide">
              <img 
                src="https://sonnycourt-videos-public.b-cdn.net/Sonny-pack-Neville-cover-vf.webp"
                alt="Syst√®me Souhaits R√©alis√©s"
                loading="lazy"
              />
              <div class="formation-info">
                <h3>Syst√®me Souhaits R√©alis√©s</h3>
                <p>Transforme tes souhaits en r√©alit√© gr√¢ce √† la reprogrammation subconsciente.</p>
                <a href="/ssr-access" class="formation-btn">Voir vid√©o gratuite</a>
              </div>
            </div>

            <!-- Formation 3: Esprit Subconscient -->
            <div class="formation-slide">
              <img 
                src="/media/pages/Sonny-Court-Manifest-Formation-2.webp"
                alt="Esprit Subconscient"
                loading="lazy"
              />
              <div class="formation-info">
                <h3>Esprit Subconscient</h3>
                <p>21 jours pour reprogrammer ton subconscient et transformer ta vie.</p>
                <a href="/es-inscription" class="formation-btn">Voir vid√©o gratuite</a>
              </div>
            </div>

            <!-- Formation 4: Neuro IA -->
            <div class="formation-slide">
              <img 
                src="/media/pages/neuroia-cover.webp"
                alt="Neuro IA"
                loading="lazy"
              />
              <div class="formation-info">
                <h3>Neuro IA</h3>
                <p>Reprogramme ton subconscient gr√¢ce √† l'Intelligence Artificielle.</p>
                <a href="https://sonnycourt.com/neuro-ia" class="formation-btn">D√©couvrir</a>
              </div>
            </div>

            <!-- Formation 5: Syst√®me Viral -->
            <div class="formation-slide">
              <img 
                src="/media/sonny_systeme-viral.webp"
                alt="Syst√®me Viral"
                loading="lazy"
              />
              <div class="formation-info">
                <h3>Syst√®me Viral</h3>
                <p>Transforme des vid√©os courtes en machine √† revenus.</p>
                <a href="https://systemeviral.com/inscription/" class="formation-btn btn-green">Voir vid√©o gratuite</a>
              </div>
            </div>
          </div>
        </div>
        
        <button class="carousel-arrow next" aria-label="Suivant">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <!-- Dots navigation -->
      <div class="carousel-dots"></div>
    </section>

    <!-- Slot pour contenu additionnel si besoin -->
    <slot />
  </div>
</Layout>

<!-- Carousel Script -->
<script>
  const track = document.querySelector('.carousel-track') as HTMLElement;
  const originalSlides = Array.from(document.querySelectorAll('.formation-slide')) as HTMLElement[];
  const prevBtn = document.querySelector('.carousel-arrow.prev');
  const nextBtn = document.querySelector('.carousel-arrow.next');
  const dotsContainer = document.querySelector('.carousel-dots');
  const carouselContainer = document.querySelector('.carousel-container');
  
  const totalOriginalSlides = originalSlides.length;
  let autoPlayInterval: number | null = null;
  let isPaused = false;
  let isTransitioning = false;

  // Fisher-Yates shuffle pour m√©langer les formations al√©atoirement
  function shuffleArray<T>(array: T[]): T[] {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }

  // M√©langer l'ordre des slides au chargement
  let shuffledSlides: HTMLElement[] = [];
  if (track && originalSlides.length > 0) {
    shuffledSlides = shuffleArray(originalSlides);
    // Clear track et ajouter les slides m√©lang√©es
    track.innerHTML = '';
    shuffledSlides.forEach(slide => track.appendChild(slide));
  }

  // Cr√©er les clones pour le carousel infini
  // On clone les 2 derni√®res slides au d√©but et les 2 premi√®res √† la fin
  const clonesAtStart: HTMLElement[] = [];
  const clonesAtEnd: HTMLElement[] = [];
  const numClones = 2; // Nombre de clones de chaque c√¥t√©

  if (track && shuffledSlides.length > 0) {
    // Cloner les derni√®res slides et les ajouter au d√©but
    for (let i = numClones - 1; i >= 0; i--) {
      const idx = (shuffledSlides.length - 1 - i + shuffledSlides.length) % shuffledSlides.length;
      const clone = shuffledSlides[idx].cloneNode(true) as HTMLElement;
      clone.classList.add('clone');
      clone.setAttribute('aria-hidden', 'true');
      clonesAtStart.push(clone);
      track.insertBefore(clone, track.firstChild);
    }
    
    // Cloner les premi√®res slides et les ajouter √† la fin
    for (let i = 0; i < numClones; i++) {
      const clone = shuffledSlides[i].cloneNode(true) as HTMLElement;
      clone.classList.add('clone');
      clone.setAttribute('aria-hidden', 'true');
      clonesAtEnd.push(clone);
      track.appendChild(clone);
    }
  }

  // L'index actuel inclut les clones au d√©but
  // Index 0-1 = clones du d√©but, 2 = premi√®re vraie slide, etc.
  let currentIndex = numClones; // Commencer √† la premi√®re vraie slide

  // Create dots (seulement pour les vraies slides)
  shuffledSlides.forEach((_, i) => {
    const dot = document.createElement('button');
    dot.classList.add('dot');
    if (i === 0) dot.classList.add('active');
    dot.addEventListener('click', () => {
      goToSlide(i + numClones); // Ajuster pour les clones
      resetAutoPlay();
    });
    dotsContainer?.appendChild(dot);
  });

  const dots = document.querySelectorAll('.dot');

  function getSlideWidth(): number {
    const firstSlide = track?.querySelector('.formation-slide') as HTMLElement;
    return firstSlide?.getBoundingClientRect().width || 300;
  }

  function updateCarousel(animate = true) {
    if (!track) return;
    const slideWidth = getSlideWidth();
    const gap = 24;
    
    if (!animate) {
      track.style.transition = 'none';
    } else {
      track.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    }
    
    track.style.transform = `translateX(-${currentIndex * (slideWidth + gap)}px)`;
    
    // Mettre √† jour les dots (convertir l'index avec clones en index r√©el)
    const realIndex = getRealIndex();
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === realIndex);
    });
  }

  function getRealIndex(): number {
    // Convertir l'index avec clones en index des vraies slides (0 √† totalOriginalSlides-1)
    let real = currentIndex - numClones;
    if (real < 0) real = totalOriginalSlides + real;
    if (real >= totalOriginalSlides) real = real - totalOriginalSlides;
    return real;
  }

  function goToSlide(index: number) {
    if (isTransitioning) return;
    currentIndex = index;
    updateCarousel();
  }

  function nextSlide() {
    if (isTransitioning) return;
    isTransitioning = true;
    currentIndex++;
    updateCarousel();
    
    // V√©rifier si on est sur un clone de fin
    setTimeout(() => {
      if (currentIndex >= totalOriginalSlides + numClones) {
        // Jump instantan√© vers la vraie slide correspondante
        currentIndex = numClones;
        updateCarousel(false);
      }
      isTransitioning = false;
    }, 420); // L√©g√®rement plus que la dur√©e de transition
  }

  function prevSlide() {
    if (isTransitioning) return;
    isTransitioning = true;
    currentIndex--;
    updateCarousel();
    
    // V√©rifier si on est sur un clone de d√©but
    setTimeout(() => {
      if (currentIndex < numClones) {
        // Jump instantan√© vers la vraie slide correspondante
        currentIndex = totalOriginalSlides + numClones - 1;
        updateCarousel(false);
      }
      isTransitioning = false;
    }, 420);
  }

  // Auto-play : d√©filement automatique toutes les 4 secondes
  function startAutoPlay() {
    if (autoPlayInterval) return;
    autoPlayInterval = window.setInterval(() => {
      if (!isPaused && !isTransitioning) {
        nextSlide();
      }
    }, 4000);
  }

  function stopAutoPlay() {
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
      autoPlayInterval = null;
    }
  }

  function resetAutoPlay() {
    stopAutoPlay();
    startAutoPlay();
  }

  // Pause au survol (desktop)
  carouselContainer?.addEventListener('mouseenter', () => {
    isPaused = true;
  });

  carouselContainer?.addEventListener('mouseleave', () => {
    isPaused = false;
  });

  // Pause au touch (mobile)
  track?.addEventListener('touchstart', () => {
    isPaused = true;
  });

  track?.addEventListener('touchend', () => {
    // Reprendre apr√®s un court d√©lai pour laisser le temps de swiper
    setTimeout(() => {
      isPaused = false;
    }, 2000);
  });

  prevBtn?.addEventListener('click', () => {
    prevSlide();
    resetAutoPlay();
  });

  nextBtn?.addEventListener('click', () => {
    nextSlide();
    resetAutoPlay();
  });

  // Touch swipe support
  let touchStartX = 0;
  let touchEndX = 0;

  track?.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  });

  track?.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    if (touchStartX - touchEndX > 50) {
      nextSlide();
      resetAutoPlay();
    } else if (touchEndX - touchStartX > 50) {
      prevSlide();
      resetAutoPlay();
    }
  });

  // Update on resize
  window.addEventListener('resize', () => updateCarousel(false));

  // Positionner initialement le carousel (sans animation)
  updateCarousel(false);
  
  // Forcer le repositionnement apr√®s un court d√©lai (pour s'assurer que les dimensions sont calcul√©es)
  requestAnimationFrame(() => {
    updateCarousel(false);
  });

  // D√©marrer l'auto-play
  startAutoPlay();
</script>

<!-- Tracking des visites (c√¥t√© serveur, sans cookies) -->
<script is:inline>
  (function() {
    try {
      const page = window.location.pathname;
      if (navigator.sendBeacon) {
        navigator.sendBeacon('/.netlify/functions/track', JSON.stringify({ page }));
      } else {
        fetch('/.netlify/functions/track', {
          method: 'POST',
          body: JSON.stringify({ page }),
          keepalive: true
        });
      }
    } catch (e) {}
  })();
</script>

<!-- Tracking activit√© subscriber (last_click dans Listmonk) -->
<script is:inline>
  (function() {
    try {
      const params = new URLSearchParams(window.location.search);
      const email = params.get('e');
      if (email) {
        fetch('/.netlify/functions/track-activity?email=' + encodeURIComponent(email));
      }
    } catch (e) {}
  })();
</script>

<!-- Share functionality -->
<script>
  const shareBtn = document.getElementById('shareMainBtn') as HTMLButtonElement | null;
  const toast = document.getElementById('shareCopiedToast');
  
  if (shareBtn) {
    const shareUrl = shareBtn.dataset.shareUrl || window.location.href;
    const shareTitle = 'Court-Circuit';
    const shareText = 'Je te partage un truc que j\'aime bien. C\'est une newsletter quotidienne sur le mindset et le subconscient. √áa prend 1 min √† lire, c\'est enrichissant, c\'est dr√¥le et c\'est gratuit.';
    
    shareBtn.addEventListener('click', async () => {
      // Essayer Web Share API (mobile natif)
      if (navigator.share) {
        try {
          await navigator.share({
            title: shareTitle,
            text: shareText,
            url: shareUrl
          });
          return;
        } catch (err) {
          // User a annul√© ou erreur - on continue avec le fallback
        }
      }
      
      // Fallback: copier le lien
      try {
        await navigator.clipboard.writeText(shareUrl);
        showToast();
      } catch (err) {
        // Fallback pour vieux navigateurs
        const textarea = document.createElement('textarea');
        textarea.value = shareUrl;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast();
      }
    });
  }
  
  function showToast() {
    if (toast) {
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
  }
</script>

<style>
  .court-circuit-page {
    min-height: 100vh;
    padding-top: 100px;
    padding-bottom: 60px;
    background: #000;
  }

  /* Image Section */
  .image-section {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    margin-bottom: 60px;
    gap: 20px;
  }

  .image-container {
    max-width: 600px;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .main-image {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Share Button */
  .share-button-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .share-btn-main {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50px;
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .share-btn-main:hover {
    background: linear-gradient(135deg, rgba(0, 122, 255, 0.3) 0%, rgba(0, 122, 255, 0.15) 100%);
    border-color: rgba(0, 122, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 122, 255, 0.2);
  }

  .share-btn-main:active {
    transform: translateY(0);
  }

  .share-btn-main svg {
    color: #007AFF;
  }

  .share-copied-toast {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: #34C759;
    color: #fff;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .share-copied-toast.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  /* Formations Carousel Section */
  .formations-carousel-section {
    padding: 0 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .section-title {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    text-align: center;
    margin-bottom: 32px;
    letter-spacing: -0.02em;
  }

  .carousel-container {
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
  }

  .carousel-track-wrapper {
    overflow: hidden;
    flex: 1;
  }

  .carousel-track {
    display: flex;
    gap: 24px;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .formation-slide {
    min-width: 300px;
    max-width: 300px;
    background: linear-gradient(145deg, #1C1C1E, #0a0a0a);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    overflow: hidden;
    flex-shrink: 0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .formation-slide:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
  }

  .formation-slide img {
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
  }

  .formation-info {
    padding: 20px;
  }

  .formation-info h3 {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    margin: 0 0 8px 0;
    letter-spacing: -0.01em;
  }

  .formation-info p {
    font-size: 14px;
    color: #8E8E93;
    line-height: 1.5;
    margin: 0 0 16px 0;
    min-height: 42px;
  }

  .formation-btn {
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
    color: #fff;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .formation-btn:hover {
    background: linear-gradient(135deg, #0051D5 0%, #0039A6 100%);
    transform: translateY(-1px);
  }

  .formation-btn.btn-green {
    background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
  }

  .formation-btn.btn-green:hover {
    background: linear-gradient(135deg, #30D158 0%, #28A745 100%);
  }

  /* Carousel Arrows */
  .carousel-arrow {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .carousel-arrow:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
  }

  /* Carousel Dots */
  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 24px;
  }

  :global(.dot) {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }

  :global(.dot.active) {
    background: #007AFF;
    transform: scale(1.2);
  }

  :global(.dot:hover:not(.active)) {
    background: rgba(255, 255, 255, 0.4);
  }

  /* Mobile */
  @media (max-width: 768px) {
    .court-circuit-page {
      padding-top: 80px;
    }

    .image-container {
      max-width: 100%;
    }

    .section-title {
      font-size: 24px;
    }

    .carousel-arrow {
      display: none;
    }

    .carousel-container {
      gap: 0;
    }

    .formation-slide {
      min-width: 280px;
      max-width: 280px;
    }
  }

  @media (max-width: 480px) {
    .formation-slide {
      min-width: 260px;
      max-width: 260px;
    }

    .formation-info {
      padding: 16px;
    }

    .formation-info h3 {
      font-size: 16px;
    }

    .formation-info p {
      font-size: 13px;
    }
  }
</style>

